# Реалізація інформаційного та програмного забезпечення

В рамках проекту розробляється: 
## SQL-скрипт для створення на початкового наповнення бази даних

```SQL
-- MySQL Script generated by MySQL Workbench
-- Tue May 23 10:27:09 2023
-- Model: New Model    Version: 1.0
-- MySQL Workbench Forward Engineering

SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0;
SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0;
SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION';

-- -----------------------------------------------------
-- Schema mydb
-- -----------------------------------------------------
DROP SCHEMA IF EXISTS `mydb` ;

-- -----------------------------------------------------
-- Schema mydb
-- -----------------------------------------------------
CREATE SCHEMA IF NOT EXISTS `mydb` DEFAULT CHARACTER SET utf8 ;
USE `mydb` ;

-- -----------------------------------------------------
-- Table `mydb`.`FILE`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `mydb`.`FILE` ;

CREATE TABLE IF NOT EXISTS `mydb`.`FILE` (
  `idFILE` INT NOT NULL,
  `file_name` VARCHAR(45) NULL,
  `file_description` VARCHAR(45) NULL,
  `file_uploadDate` DATE NULL,
  `file_format` VARCHAR(45) NULL,
  PRIMARY KEY (`idFILE`))
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `mydb`.`SEARCH`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `mydb`.`SEARCH` ;

CREATE TABLE IF NOT EXISTS `mydb`.`SEARCH` (
  `idSEARCH` INT NOT NULL,
  `srch_date` DATE NULL,
  `srch_keyword` VARCHAR(45) NULL,
  `srch_format` INT NULL,
  `FILE_idFILE` INT NOT NULL,
  PRIMARY KEY (`idSEARCH`),
  INDEX `fk_SEARCH_FILE1_idx` (`FILE_idFILE` ASC) VISIBLE,
  CONSTRAINT `fk_SEARCH_FILE1`
    FOREIGN KEY (`FILE_idFILE`)
    REFERENCES `mydb`.`FILE` (`idFILE`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `mydb`.`REQUEST`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `mydb`.`REQUEST` ;

CREATE TABLE IF NOT EXISTS `mydb`.`REQUEST` (
  `idREQUEST` INT NOT NULL,
  `SEARCH_idSEARCH` INT NOT NULL,
  PRIMARY KEY (`idREQUEST`),
  INDEX `fk_REQUEST_SEARCH1_idx` (`SEARCH_idSEARCH` ASC) VISIBLE,
  CONSTRAINT `fk_REQUEST_SEARCH1`
    FOREIGN KEY (`SEARCH_idSEARCH`)
    REFERENCES `mydb`.`SEARCH` (`idSEARCH`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `mydb`.`USER`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `mydb`.`USER` ;

CREATE TABLE IF NOT EXISTS `mydb`.`USER` (
  `idUSER` INT NOT NULL,
  `user_username` VARCHAR(45) NOT NULL,
  `user_email` VARCHAR(45) NOT NULL,
  `user_password` VARCHAR(45) NOT NULL,
  `user_registration` TINYINT NULL,
  `user_firstname` VARCHAR(45) NULL,
  `user_lastname` VARCHAR(45) NULL,
  `REQUEST_idREQUEST` INT NOT NULL,
  PRIMARY KEY (`idUSER`),
  UNIQUE INDEX `user_id_UNIQUE` (`idUSER` ASC) VISIBLE,
  UNIQUE INDEX `user_username_UNIQUE` (`user_username` ASC) VISIBLE,
  UNIQUE INDEX `user_email_UNIQUE` (`user_email` ASC) VISIBLE,
  INDEX `fk_USER_REQUEST1_idx` (`REQUEST_idREQUEST` ASC) VISIBLE,
  CONSTRAINT `fk_USER_REQUEST1`
    FOREIGN KEY (`REQUEST_idREQUEST`)
    REFERENCES `mydb`.`REQUEST` (`idREQUEST`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `mydb`.`STAFFLOGIN`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `mydb`.`STAFFLOGIN` ;

CREATE TABLE IF NOT EXISTS `mydb`.`STAFFLOGIN` (
  `idSTAFFLOGIN` VARCHAR(45) NOT NULL,
  `IS_staff` TINYINT NULL,
  `USER_idUSER` INT NOT NULL,
  PRIMARY KEY (`idSTAFFLOGIN`, `USER_idUSER`),
  INDEX `fk_STAFFLOGIN_USER1_idx` (`USER_idUSER` ASC) VISIBLE,
  CONSTRAINT `fk_STAFFLOGIN_USER1`
    FOREIGN KEY (`USER_idUSER`)
    REFERENCES `mydb`.`USER` (`idUSER`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `mydb`.`EDITOR`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `mydb`.`EDITOR` ;

CREATE TABLE IF NOT EXISTS `mydb`.`EDITOR` (
  `idEDITOR` INT NOT NULL,
  `STAFFLOGIN_idSTAFFLOGIN` VARCHAR(45) NOT NULL,
  PRIMARY KEY (`idEDITOR`),
  INDEX `fk_EDITOR_STAFFLOGIN_idx` (`STAFFLOGIN_idSTAFFLOGIN` ASC) VISIBLE,
  CONSTRAINT `fk_EDITOR_STAFFLOGIN`
    FOREIGN KEY (`STAFFLOGIN_idSTAFFLOGIN`)
    REFERENCES `mydb`.`STAFFLOGIN` (`idSTAFFLOGIN`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `mydb`.`BRANCH`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `mydb`.`BRANCH` ;

CREATE TABLE IF NOT EXISTS `mydb`.`BRANCH` (
  `idBRANCH` INT NOT NULL,
  `branch_chng` LONGTEXT NULL,
  `EDITOR_idEDITOR` INT NOT NULL,
  PRIMARY KEY (`idBRANCH`),
  UNIQUE INDEX `idBranch_UNIQUE` (`idBRANCH` ASC) VISIBLE,
  INDEX `fk_BRANCH_EDITOR1_idx` (`EDITOR_idEDITOR` ASC) VISIBLE,
  CONSTRAINT `fk_BRANCH_EDITOR1`
    FOREIGN KEY (`EDITOR_idEDITOR`)
    REFERENCES `mydb`.`EDITOR` (`idEDITOR`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `mydb`.`ADMINISTRATOR`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `mydb`.`ADMINISTRATOR` ;

CREATE TABLE IF NOT EXISTS `mydb`.`ADMINISTRATOR` (
  `idADMINISTRATOR` INT NOT NULL,
  `adm_delete` TINYINT NULL,
  `adm_upload` LONGTEXT NULL,
  `adm_annotation_chng` LONGTEXT NULL,
  `adm_control` TINYINT NULL,
  `STAFFLOGIN_idSTAFFLOGIN` VARCHAR(45) NOT NULL,
  PRIMARY KEY (`idADMINISTRATOR`),
  INDEX `fk_ADMINISTRATOR_STAFFLOGIN1_idx` (`STAFFLOGIN_idSTAFFLOGIN` ASC) VISIBLE,
  CONSTRAINT `fk_ADMINISTRATOR_STAFFLOGIN1`
    FOREIGN KEY (`STAFFLOGIN_idSTAFFLOGIN`)
    REFERENCES `mydb`.`STAFFLOGIN` (`idSTAFFLOGIN`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB;


SET SQL_MODE=@OLD_SQL_MODE;
SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS;
SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS;
```
## RESTfull сервіс для управління даними
```RESTfull
import fastapi
from fastapi import FastAPI, Request
from fastapi.responses import JSONResponse
import pymysql
import uvicorn
from fastapi import Form

app = FastAPI()

class DataBase(object):
    def __new__(cls):
        if not hasattr(cls, 'instance'):
            cls.instance = super(DataBase, cls).__new__(cls)
        return cls.instance

    def __init__(self):
        self.connection = None
        self.cursor = None
        self.__connect()

    def __connect(self):
        self.connection = pymysql.connect(
            host='localhost',
            port=3306,
            user='root',
            password='SQLServerPassword23',
            database='mydb',
        )
        self.cursor = self.connection.cursor(pymysql.cursors.DictCursor)


    def execute(self, command):
        self.cursor.execute(command)
        result = self.cursor.fetchall()
        self.connection.commit()
        return result


@app.get("/")
async def root():
    return {"message": "Hello, world!"}


@app.get("/api/allusers")
async def get_users(request: Request):
    db = DataBase()
    return JSONResponse(db.execute('SELECT * FROM user'))


@app.get('/api/user/{id}')
def get_user_by_id(request: Request, id: int):
    db = DataBase()
    result = db.execute(f'SELECT * FROM user WHERE idUSER={id}')
    if not result:
        raise fastapi.HTTPException(status_code=404)
    return JSONResponse(result)


@app.post('/api/adduser', status_code=201)
async def add_new_user(request: Request, username: str, email: str, password: str):
    with open('UserId.txt', 'r') as file:
        last_id = file.read()
        print(last_id)
        file.close()
    try:
        ID = str(int(last_id)+1)
        Request = 1
        with open('UserId.txt', 'w') as file:
            file.write(str(int(last_id)+1))
            file.close()
    except KeyError:
        raise fastapi.HTTPException(status_code=400)

    db = DataBase()
    db.execute(f"INSERT INTO `user`(idUSER, user_username, user_email, user_password, REQUEST_idREQUEST) "
               f"VALUES ('{ID}','{username}','{email}','{password}',{Request});")
    return {'message': 'New user added!'}


@app.put('/api/updateuser/{id}')
async def update_user(id: int, username: str = Form(None), email: str = Form(None), password: str = Form(None)):
    db = DataBase()
    if not db.execute(f'SELECT * FROM user WHERE idUSER={id}'):
        raise fastapi.HTTPException(status_code=404, detail='User not found')

    if username is None and email is None and password is None:
        raise fastapi.HTTPException(status_code=400, detail='At least one field must be provided')

    update_fields = []
    if username is not None:
        update_fields.append(f'user_username="{username}"')
    if email is not None:
        update_fields.append(f'user_email="{email}"')
    if password is not None:
        update_fields.append(f'user_password="{password}"')

    update_query = ", ".join(update_fields)
    db.execute(f'UPDATE user SET {update_query} WHERE idUSER={id}')
    return {"message": 'Updated!'}



@app.delete('/api/deleteuser/{id}')
def delete_user(request: Request, id: int):
    db = DataBase()
    result = db.execute(f'SELECT * FROM `user` WHERE idUSER={id}')
    if not result:
        raise fastapi.HTTPException(status_code=404)
    db.execute(f'DELETE FROM `user` WHERE idUSER={id}')
    return {'message': f'User with id={id} deleted'}

if __name__ == "__main__":
    uvicorn.run(app, host="127.0.0.1", port=5049)
```
